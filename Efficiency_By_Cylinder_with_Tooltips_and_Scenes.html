<html>
<head>
  <title>Find a Fuel Efficient Car</title>
  <script src='https://d3js.org/d3.v5.min.js'></script>
  <style>
    body {
      font-family: sans-serif;
    }
    #tooltip {
      opacity: 0;
      position: absolute;
      text-align: center;
      width: 180px; height: 60px;
      background: white;
      border: 0px;
      pointer-events: none;
      cursor: default;
    }
  </style>
</head>
<body onload="init()">
  <h1>Average Fuel Efficiencies across Car Manufacturers</h1>
  <p>Even though it may appear that cars manufactured by certain brands tend to have a higher fuel efficiency, a buyer must remember to consider their "performance segment" of interest before comparing brands. Take Honda for example. Across all the cars they manufacture, their average fuel efficiency may seem intermediate. However, navigating to Scene 2 reveals that Honda leads the 4-cylinder segment in fuel efficiency. This is because fuel efficiency generally decreases with increasing engine cylinders and Honda competes in several market segments. Use our visualizations in Scene 3 to find the most fuel efficient brand in the performance segment of your interest! Hover over any bar to show additional useful details</p>
  <div>
    <button onclick="Scene_Selector('all')">Scene 1</button>
    <button onclick="Scene_Selector('4')">Scene 2</button>
    <button onclick="Scene_Selector('customizable')">Scene 3</button>
  </div>

  <div id="Scene_Parameter" style="margin-top: 10px; font-weight: bold; font-size: 16px;"></div>

  <svg width="1200" height="500"></svg>

  <div id="dropdown" style="display: none;">
    <label for="Cyl_Selector">Select Number of Cylinders:</label>
    <select id="Cyl_Selector"></select>
  </div>
 
  <div id="tooltip"></div>

  <script>
    async function init() {
      data = await d3.csv('https://flunky.github.io/cars2017.csv');
      data.forEach(function(d) {
        d.EngineCylinders = +d.EngineCylinders;
        d.AverageCityMPG = +d.AverageCityMPG;
        d.AverageHighwayMPG = +d.AverageHighwayMPG;
        d.AverageMPG = (d.AverageCityMPG + d.AverageHighwayMPG)/2;
      });

      Options_cyl = ["All"].concat(
         Array.from(new Set(data.map(function(d) { return d.EngineCylinders; }))).sort(function(a, b) { return a-b; })
      );

      d3.select("#Cyl_Selector").selectAll("option")
        .data(Options_cyl)
        .enter()
        .append("option")
        .text(function(d) { return d; })
        .attr("value", function(d) { return d; });

      d3.select("#Cyl_Selector").on("change", function () {
        Chart_Updater(this.value);
        d3.select("#Scene_Parameter").text(`Number of Cylinders: ${this.value}`);
      });

      Scene_Selector('all');
    }

    
    function Scene_Selector(Scene) {
      d3.select("#dropdown").style("display", Scene === "customizable" ? "block" : "none");

      if (Scene === "all") {
        Present_Scene = 'all';
        Chart_Updater("All");
        Description = "Number of Cylinders: All";
      } else if (Scene === "4") {
        Present_Scene = '4';
        Chart_Updater(4);
        Description = "Number of Cylinders: 4";
      } else if (Scene === "customizable") {
        Present_Scene = 'customizable';
        Selected = d3.select("#Cyl_Selector").property("value");
        Chart_Updater(Selected);
        Description = `Number of Cylinders: ${Selected}`;
      }
      d3.select("#Scene_Parameter").text(Description);
    }
    
    function Chart_Updater(cylinders){
      d3.select("svg").html("");
      tooltip = d3.select("#tooltip");
      plotarea = d3.select("svg").append("g").attr("transform", "translate(60,30)");

      d3.select("svg").append("text")
              .attr("transform","translate(550,495)")
              .style("text-anchor", "middle")
              .style("font-size", "16px")
              .style("font-weight", "bold")
              .text("Car brands sorted in decreasing order of average fuel efficiency");

      d3.select("svg").append("text")
              .attr("transform","translate(16,250) rotate(-90)")
              .style("text-anchor", "middle")
              .style("font-size", "16px")
              .style("font-weight", "bold")
              .text("Average MPG");

      x = d3.scaleBand().range([0, 1100]).padding(0.2);
      y = d3.scaleLinear().range([350, 0]);

      X_Axis = d3.select("svg").append("g").attr("transform", "translate(60,380)");
      Y_Axis = d3.select("svg").append("g").attr("transform", "translate(60,30)");
      
      filtered = cylinders ==="All"
          ?data
          :data.filter(function(d) {return d.EngineCylinders == cylinders; });

      brand_avgs = d3.nest()
          .key(function(d) {return d.Make; })
          .rollup(function(v){
            return {
               count: v.length,
               avgMPG: d3.mean(v, function(d){ return d.AverageMPG; })
            };
          })
          .entries(filtered)
          .map(function(d){
            return{
              make: d.key,
              count: d.value.count,
              avgMPG: d.value.avgMPG
            };
          })
          .sort(function(a, b){ return b.avgMPG - a.avgMPG; });

      x.domain(brand_avgs.map(function(d) { return d.make; }));
      y.domain([0, d3.max(brand_avgs, function(d){ return d.avgMPG; })]);

      if(Present_Scene === 'all'){
         d3.select("svg").append("line")
           .attr("x1", 60)
           .attr("x2", 740)
           .attr("y1", y(30.17) + 30)
           .attr("y2", y(30.17) + 30)
           .attr("stroke", "red")
           .attr("stroke-width", 2)
           .attr("stroke-dasharray", "4 2");

         d3.select("svg").append("text")
              .attr("x",750)
              .attr("y",y(30.17) + 25)
              .style("text-anchor", "left")
              .style("font-size", "16px")
              .text("It may appear that Honda is not amongst the most");

         d3.select("svg").append("text")
              .attr("x",750)
              .attr("y",y(30.17) + 45)
              .style("text-anchor", "left")
              .style("font-size", "16px")
              .text("fuel efficient car brands at an avg. MPG of 30.2");
      }
      
      if(Present_Scene === '4'){
         d3.select("svg").append("line")
           .attr("x1", 60)
           .attr("x2", 740)
           .attr("y1", y(30.17) + 30)
           .attr("y2", y(30.17) + 30)
           .attr("stroke", "red")
           .attr("stroke-width", 2)
           .attr("stroke-dasharray", "4 2");

         d3.select("svg").append("text")
              .attr("x",750)
              .attr("y",y(30.17) + 35)
              .style("text-anchor", "left")
              .style("font-size", "16px")
              .text("Avg. fuel efficiency across all Honda Cars: 30.2 MPG");

         d3.select("svg").append("line")
           .attr("x1", 60)
           .attr("x2", 740)
           .attr("y1", y(33.50) + 30)
           .attr("y2", y(33.50) + 30)
           .attr("stroke", "green")
           .attr("stroke-width", 2)
           .attr("stroke-dasharray", "4 2"); 

         d3.select("svg").append("text")
              .attr("x",750)
              .attr("y",y(33.50) + 25)
              .style("text-anchor", "left")
              .style("font-size", "16px")
              .text("But in fact, Honda leads the 4-cylinder category with");

         d3.select("svg").append("text")
              .attr("x",750)
              .attr("y",y(33.50) + 45)
              .style("text-anchor", "left")
              .style("font-size", "16px")
              .text("an average fuel efficiency of 33.5 MPG");
      }

      if(Present_Scene === 'customizable'){
         d3.select("svg").append("text")
              .attr("x",600)
              .attr("y",18)
              .style("text-anchor", "middle")
              .style("font-size", "18px")
              .style("font-weight", "bold")
              .text("Use the dropdown options to find the most fuel efficient brand in your segment of interest!");
      }

      X_Axis.call(d3.axisBottom(x))
        .selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end")
        .attr("dx","-1em")
        .attr("dy","0.1em")
        .style("font-size","14px");

      Y_Axis.call(d3.axisLeft(y))
        .style("font-size","14px");

      bars = plotarea.selectAll("rect").data(brand_avgs, function(d) {return d.make; });

      bars.enter()
        .append("rect")
        .attr("fill", "steelblue")
        .attr("x", function(d) { return x(d.make); })
        .attr("y", function(d) { return y(d.avgMPG); })
        .attr("width", x.bandwidth())
        .attr("height", function(d) { return 350 - y(d.avgMPG); })
        .on("mouseover",function(d,i) {
            tooltip.style("opacity",1)
                   .style("left",(d3.event.pageX)+"px")
                   .style("top",(d3.event.pageY)+"px")
                   .html(d.make + "<br>No of cars: " + d.count + "<br>Avg MPG: " + d.avgMPG.toFixed(2));
        })
        .on("mouseout",function() { tooltip.style("opacity", 0) });

      bars.exit().remove();
    }
</script>
</body>
</html>